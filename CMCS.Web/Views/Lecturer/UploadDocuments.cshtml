@using System.IO
@model CMCS.Web.Models.ViewModels.DocumentUploadViewModel
@{
	ViewData["Title"] = "Upload Documents - Claim #" + Model.ClaimId;
}

<div class="row">
	<div class="col-lg-10 mx-auto">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<div>
				<h1 class="mb-1">üìé Upload Supporting Documents</h1>
				<p class="text-muted mb-0">Upload supporting documents for Claim #@Model.ClaimId</p>
			</div>
			<a asp-action="MyClaims" class="btn btn-outline-secondary">
				‚Üê Back to My Claims
			</a>
		</div>

		@if (TempData["SuccessMessage"] != null)
		{
			<div class="alert alert-success alert-dismissible fade show" role="alert">
				<strong>‚úì Success!</strong> @TempData["SuccessMessage"]
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		}

		@if (TempData["ErrorMessage"] != null)
		{
			<div class="alert alert-danger alert-dismissible fade show" role="alert">
				<strong>‚úó Error!</strong> @TempData["ErrorMessage"]
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		}

		<!-- Upload Form Card -->
		<div class="card shadow-sm mb-4">
			<div class="card-header bg-primary text-white">
				<h5 class="card-title mb-0">üì§ Upload New Documents</h5>
			</div>
			<div class="card-body">
				<form asp-action="UploadDocuments" asp-route-id="@Model.ClaimId" method="post" enctype="multipart/form-data" id="uploadForm">
					@Html.AntiForgeryToken()
					
					<div class="mb-3">
						<label for="files" class="form-label fw-semibold">
							Select Supporting Documents <span class="text-danger">*</span>
						</label>
						<input type="file" 
							   class="form-control" 
							   id="files" 
							   name="files" 
							   multiple 
							   accept=".pdf,.docx,.doc,.xlsx,.xls" 
							   required />
						<div class="form-text">
							<strong>Allowed formats:</strong> PDF, DOCX, DOC, XLSX, XLS<br/>
							<strong>Maximum file size:</strong> 5 MB per file<br/>
							<strong>Tip:</strong> You can select multiple files at once
						</div>
					</div>

					<div class="mb-3" id="selectedFilesPreview" style="display: none;">
						<h6 class="fw-semibold">Selected Files:</h6>
						<div id="filesList" class="alert alert-info small mb-0"></div>
					</div>

					<div class="alert alert-warning small">
						<strong>‚ö†Ô∏è Important:</strong> Please ensure all documents are clearly labeled and relevant to this claim. Documents may include timesheets, attendance records, or any other supporting evidence.
					</div>

					<div class="d-grid gap-2 d-md-flex justify-content-md-end">
						<button type="reset" class="btn btn-outline-secondary" id="resetBtn">
							Clear Selection
						</button>
						<button type="submit" class="btn btn-primary btn-lg px-4" id="uploadBtn">
							<span class="fw-semibold">üì§ Upload Documents</span>
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Existing Documents Card -->
		<div class="card shadow-sm">
			<div class="card-header bg-secondary text-white">
				<h5 class="card-title mb-0">üìã Uploaded Documents (@Model.ExistingDocuments.Count)</h5>
			</div>
			<div class="card-body p-0">
				@if (Model.ExistingDocuments.Any())
				{
					<div class="table-responsive">
						<table class="table table-hover mb-0">
							<thead class="table-light">
								<tr>
									<th style="width: 5%;">#</th>
									<th style="width: 45%;">File Name</th>
									<th style="width: 15%;">File Type</th>
									<th style="width: 20%;">Uploaded Date</th>
									<th style="width: 15%;" class="text-center">Actions</th>
								</tr>
							</thead>
							<tbody>
								@for (int i = 0; i < Model.ExistingDocuments.Count; i++)
								{
									var doc = Model.ExistingDocuments[i];
									var extension = System.IO.Path.GetExtension(doc.FileName).ToLowerInvariant();
									string fileIcon;
									if (extension == ".pdf")
									{
										fileIcon = "üìï";
									}
									else if (extension == ".docx" || extension == ".doc")
									{
										fileIcon = "üìò";
									}
									else if (extension == ".xlsx" || extension == ".xls")
									{
										fileIcon = "üìó";
									}
									else
									{
										fileIcon = "üìÑ";
									}

									<tr>
										<td class="fw-semibold text-muted">@(i + 1)</td>
										<td>
											<span class="me-2">@fileIcon</span>
											<strong>@doc.FileName</strong>
										</td>
										<td>
											<span class="badge bg-secondary">@extension.TrimStart('.').ToUpper()</span>
										</td>
										<td>
											<small>@doc.UploadedAt.ToString("MMM dd, yyyy HH:mm")</small>
										</td>
										<td class="text-center">
											<div class="btn-group btn-group-sm" role="group">
												<a href="@doc.FilePath" class="btn btn-outline-primary" target="_blank" title="View Document">
													üëÅÔ∏è View
												</a>
												<button type="button" 
														class="btn btn-outline-danger delete-doc-btn" 
														data-doc-id="@doc.Id" 
														data-doc-name="@doc.FileName"
														data-doc-path="@doc.FilePath"
														title="Delete Document">
													üóëÔ∏è Delete
												</button>
											</div>
										</td>
									</tr>
								}
							</tbody>
						</table>
					</div>
				}
				else
				{
					<div class="text-center py-5 text-muted">
						<div class="mb-3">
							<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-file-earmark-arrow-up" viewBox="0 0 16 16">
								<path d="M8.5 11.5a.5.5 0 0 1-1 0V7.707L6.354 8.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 7.707V11.5z"/>
								<path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
							</svg>
						</div>
						<h5>No documents uploaded yet</h5>
						<p>Upload supporting documents using the form above</p>
					</div>
				}
			</div>
		</div>

		<div class="mt-3">
			<div class="alert alert-info small">
				<strong>‚ÑπÔ∏è Document Guidelines:</strong>
				<ul class="mb-0 mt-2">
					<li>Upload all relevant supporting documents (timesheets, attendance records, etc.)</li>
					<li>Ensure documents are clear and legible</li>
					<li>File names should be descriptive (e.g., "Timesheet_October_2025.pdf")</li>
					<li>You can upload multiple documents at once</li>
					<li>Previously uploaded documents can be viewed or deleted</li>
				</ul>
			</div>
		</div>
	</div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form id="deleteForm" method="post" asp-action="DeleteDocument">
				@Html.AntiForgeryToken()
				<input type="hidden" id="deleteClaimId" name="claimId" value="@Model.ClaimId" />
				<input type="hidden" id="deleteDocId" name="documentId" />
				<input type="hidden" id="deleteFilePath" name="filePath" />
				<div class="modal-header bg-danger text-white">
					<h5 class="modal-title" id="deleteModalLabel">üóëÔ∏è Delete Document</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>Are you sure you want to delete this document?</p>
					<div class="alert alert-warning">
						<strong>File:</strong> <span id="deleteDocName"></span>
					</div>
					<p class="text-danger mb-0"><strong>Warning:</strong> This action cannot be undone.</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-danger">üóëÔ∏è Delete Document</button>
				</div>
			</form>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		$(document).ready(function() {
			// File selection preview
			$('#files').on('change', function() {
				const files = this.files;
				if (files.length > 0) {
					let filesList = '<ul class="mb-0">';
					const maxSize = 5 * 1024 * 1024; // 5 MB
					let hasError = false;

					for (let i = 0; i < files.length; i++) {
						const file = files[i];
						const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
						const extension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
						const allowedExtensions = ['.pdf', '.docx', '.doc', '.xlsx', '.xls'];

						let statusIcon = '‚úì';
						let statusClass = 'text-success';

						if (file.size > maxSize) {
							statusIcon = '‚úó';
							statusClass = 'text-danger';
							hasError = true;
						} else if (!allowedExtensions.includes(extension)) {
							statusIcon = '‚úó';
							statusClass = 'text-danger';
							hasError = true;
						}

						filesList += `<li class="${statusClass}"><strong>${statusIcon}</strong> ${file.name} (${sizeInMB} MB)</li>`;
					}
					filesList += '</ul>';

					$('#filesList').html(filesList);
					$('#selectedFilesPreview').show();

					// Disable upload button if there are errors
					$('#uploadBtn').prop('disabled', hasError);
				} else {
					$('#selectedFilesPreview').hide();
					$('#uploadBtn').prop('disabled', false);
				}
			});

			// Reset button
			$('#resetBtn').on('click', function() {
				$('#selectedFilesPreview').hide();
				$('#uploadBtn').prop('disabled', false);
			});

			// Delete button
			$('.delete-doc-btn').on('click', function() {
				const docId = $(this).data('doc-id');
				const docName = $(this).data('doc-name');
				const docPath = $(this).data('doc-path');

				$('#deleteDocId').val(docId);
				$('#deleteDocName').text(docName);
				$('#deleteFilePath').val(docPath);

				$('#deleteModal').modal('show');
			});

			// Form validation
			$('#uploadForm').on('submit', function(e) {
				const files = $('#files')[0].files;
				if (files.length === 0) {
					e.preventDefault();
					alert('Please select at least one file to upload.');
					return false;
				}
			});
		});
	</script>
}


