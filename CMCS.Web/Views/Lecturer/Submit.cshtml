@model CMCS.Web.Models.ViewModels.ClaimSubmissionViewModel
@{
	ViewData["Title"] = "Submit Claim";
}

<div class="row">
	<div class="col-lg-10 col-xl-9 mx-auto">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<div>
				<h1 class="mb-1">üìù Submit New Claim</h1>
				<p class="text-muted mb-0">Complete the form below to submit your monthly claim</p>
			</div>
			<a asp-action="MyClaims" class="btn btn-outline-secondary">
				<i class="bi bi-arrow-left"></i> My Claims
			</a>
		</div>

		@if (TempData["ErrorMessage"] != null)
		{
			<div class="alert alert-danger alert-dismissible fade show" role="alert">
				<strong>Error!</strong> @TempData["ErrorMessage"]
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		}

		<div class="card shadow-sm">
			<div class="card-body p-4">
				<form asp-action="Submit" method="post" id="claimForm">
					@Html.AntiForgeryToken()
					<div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

					<!-- Claim Period Section -->
					<div class="mb-4">
						<h5 class="card-title mb-3">üìÖ Claim Period</h5>
						<div class="row g-3">
							<div class="col-md-4">
								<label asp-for="Month" class="form-label fw-semibold">Month <span class="text-danger">*</span></label>
								<select asp-for="Month" class="form-select">
									<option value="">Select Month</option>
									<option value="1">January</option>
									<option value="2">February</option>
									<option value="3">March</option>
									<option value="4">April</option>
									<option value="5">May</option>
									<option value="6">June</option>
									<option value="7">July</option>
									<option value="8">August</option>
									<option value="9">September</option>
									<option value="10">October</option>
									<option value="11">November</option>
									<option value="12">December</option>
								</select>
								<span asp-validation-for="Month" class="text-danger small"></span>
							</div>
							<div class="col-md-4">
								<label asp-for="Year" class="form-label fw-semibold">Year <span class="text-danger">*</span></label>
								<input asp-for="Year" type="number" class="form-control" placeholder="e.g., 2025" />
								<span asp-validation-for="Year" class="text-danger small"></span>
							</div>
							<div class="col-md-4">
								<label asp-for="HourlyRate" class="form-label fw-semibold">Hourly Rate (R) <span class="text-danger">*</span></label>
								<input asp-for="HourlyRate" type="number" step="0.01" class="form-control" placeholder="e.g., 500.00" id="hourlyRate" />
								<span asp-validation-for="HourlyRate" class="text-danger small"></span>
							</div>
						</div>
					</div>

					<hr class="my-4" />

					<!-- Activities Section -->
					<div class="mb-4">
						<div class="d-flex justify-content-between align-items-center mb-3">
							<h5 class="card-title mb-0">‚è±Ô∏è Activities & Hours Worked</h5>
							<button type="button" class="btn btn-sm btn-outline-primary" id="addRowBtn">
								<span>+ Add Activity</span>
							</button>
						</div>

						<div class="table-responsive">
							<table class="table table-hover align-middle" id="activitiesTable">
								<thead class="table-light">
									<tr>
										<th style="width: 5%;">#</th>
										<th style="width: 55%;">Activity Description <span class="text-danger">*</span></th>
										<th style="width: 25%;">Hours Worked <span class="text-danger">*</span></th>
										<th style="width: 15%;" class="text-center">Action</th>
									</tr>
								</thead>
								<tbody id="activitiesBody">
									@for (int i = 0; i < Math.Max(Model.Items?.Count ?? 0, 1); i++)
									{
										<tr class="activity-row">
											<td class="row-number fw-semibold text-muted">@(i + 1)</td>
											<td>
												<input type="text" 
													   name="Items[@i].ActivityDescription" 
													   value="@(Model.Items?.ElementAtOrDefault(i)?.ActivityDescription ?? "")"
													   class="form-control activity-description" 
													   placeholder="e.g., Lecture: PROG6212, Tutorial: ICE Task 1" 
													   maxlength="200" />
												<span class="text-danger small validation-msg"></span>
											</td>
											<td>
												<input type="number" 
													   name="Items[@i].Hours" 
													   value="@(Model.Items?.ElementAtOrDefault(i)?.Hours ?? 0)"
													   class="form-control hours-input" 
													   placeholder="0.00" 
													   step="0.25" 
													   min="0.01" 
													   max="500" />
												<span class="text-danger small validation-msg"></span>
											</td>
											<td class="text-center">
												<button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" title="Remove this activity">
													üóëÔ∏è Remove
												</button>
											</td>
										</tr>
									}
								</tbody>
							</table>
						</div>

						<div class="alert alert-info small mb-0">
							<strong>üí° Tip:</strong> Be specific with your activity descriptions. Include course codes, session types, and topics covered.
						</div>
					</div>

					<hr class="my-4" />

					<!-- Additional Notes Section -->
					<div class="mb-4">
						<h5 class="card-title mb-3">üìã Additional Notes (Optional)</h5>
						<textarea asp-for="AdditionalNotes" 
								  class="form-control" 
								  rows="4" 
								  placeholder="Add any additional information or comments about this claim..." 
								  maxlength="500"></textarea>
						<div class="form-text">
							<span id="notesCharCount">0</span> / 500 characters
						</div>
						<span asp-validation-for="AdditionalNotes" class="text-danger small"></span>
					</div>

					<hr class="my-4" />

					<!-- Summary Section -->
					<div class="mb-4">
						<div class="card bg-light border-0">
							<div class="card-body">
								<h5 class="card-title mb-3">üí∞ Claim Summary</h5>
								<div class="row g-3">
									<div class="col-md-4">
										<div class="d-flex justify-content-between">
											<span class="text-muted">Total Hours:</span>
											<strong id="totalHours" class="text-primary">0.00</strong>
										</div>
									</div>
									<div class="col-md-4">
										<div class="d-flex justify-content-between">
											<span class="text-muted">Hourly Rate:</span>
											<strong id="displayRate" class="text-primary">R 0.00</strong>
										</div>
									</div>
									<div class="col-md-4">
										<div class="d-flex justify-content-between">
											<span class="text-muted">Total Amount:</span>
											<strong id="totalAmount" class="text-success fs-5">R 0.00</strong>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Submit Button -->
					<div class="d-grid gap-2 d-md-flex justify-content-md-end">
						<a asp-action="Dashboard" class="btn btn-lg btn-outline-secondary">
							Cancel
						</a>
						<button type="submit" class="btn btn-lg btn-success px-5" id="submitBtn">
							<span class="fw-semibold">‚úì Submit Claim</span>
						</button>
					</div>
				</form>
			</div>
		</div>

		<div class="mt-3 text-muted small text-center">
			<p class="mb-0">‚ö†Ô∏è Please review all information carefully before submitting. You can track your claim status in "My Claims".</p>
		</div>
	</div>
</div>

@section Scripts {
	@{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
	<script>
		let rowCounter = @(Model.Items?.Count ?? 1);

		$(document).ready(function() {
			updateCalculations();
			updateRowNumbers();
			updateCharacterCount();

			// Add new activity row
			$('#addRowBtn').click(function() {
				addActivityRow();
			});

			// Remove activity row
			$(document).on('click', '.remove-row-btn', function() {
				if ($('.activity-row').length > 1) {
					$(this).closest('tr').remove();
					updateRowNumbers();
					updateCalculations();
				} else {
					alert('You must have at least one activity.');
				}
			});

			// Update calculations on input change
			$(document).on('input', '.hours-input, #hourlyRate', function() {
				updateCalculations();
			});

			// Character count for notes
			$('#AdditionalNotes').on('input', function() {
				updateCharacterCount();
			});

			// Form validation before submit
			$('#claimForm').submit(function(e) {
				let isValid = true;
				$('.validation-msg').text('');

				// Validate activities
				$('.activity-row').each(function() {
					const description = $(this).find('.activity-description').val().trim();
					const hours = parseFloat($(this).find('.hours-input').val()) || 0;

					if (description && hours <= 0) {
						$(this).find('.hours-input').next('.validation-msg').text('Hours must be greater than 0');
						isValid = false;
					}
					if (hours > 0 && !description) {
						$(this).find('.activity-description').next('.validation-msg').text('Description is required');
						isValid = false;
					}
				});

				// Check if at least one activity is filled
				let hasActivity = false;
				$('.activity-row').each(function() {
					const description = $(this).find('.activity-description').val().trim();
					const hours = parseFloat($(this).find('.hours-input').val()) || 0;
					if (description && hours > 0) {
						hasActivity = true;
					}
				});

				if (!hasActivity) {
					alert('Please add at least one activity with description and hours.');
					isValid = false;
				}

				return isValid;
			});
		});

		function addActivityRow() {
			const newRow = `
				<tr class="activity-row">
					<td class="row-number fw-semibold text-muted">${rowCounter + 1}</td>
					<td>
						<input type="text" 
							   name="Items[${rowCounter}].ActivityDescription" 
							   class="form-control activity-description" 
							   placeholder="e.g., Lecture: PROG6212, Tutorial: ICE Task 1" 
							   maxlength="200" />
						<span class="text-danger small validation-msg"></span>
					</td>
					<td>
						<input type="number" 
							   name="Items[${rowCounter}].Hours" 
							   class="form-control hours-input" 
							   placeholder="0.00" 
							   step="0.25" 
							   min="0.01" 
							   max="500" 
							   value="0" />
						<span class="text-danger small validation-msg"></span>
					</td>
					<td class="text-center">
						<button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" title="Remove this activity">
							üóëÔ∏è Remove
						</button>
					</td>
				</tr>
			`;
			$('#activitiesBody').append(newRow);
			rowCounter++;
			updateRowNumbers();
		}

		function updateRowNumbers() {
			$('.activity-row').each(function(index) {
				$(this).find('.row-number').text(index + 1);
			});
		}

		function updateCalculations() {
			let totalHours = 0;
			$('.hours-input').each(function() {
				const hours = parseFloat($(this).val()) || 0;
				totalHours += hours;
			});

			const hourlyRate = parseFloat($('#hourlyRate').val()) || 0;
			const totalAmount = totalHours * hourlyRate;

			$('#totalHours').text(totalHours.toFixed(2));
			$('#displayRate').text('R ' + hourlyRate.toFixed(2));
			$('#totalAmount').text('R ' + totalAmount.toFixed(2));
		}

		function updateCharacterCount() {
			const count = $('#AdditionalNotes').val().length;
			$('#notesCharCount').text(count);
		}
	</script>
}


