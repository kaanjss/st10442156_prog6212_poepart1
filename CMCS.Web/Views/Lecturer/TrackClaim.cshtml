@using CMCS.Web.Models.ViewModels
@model CMCS.Web.Models.ViewModels.ClaimStatusViewModel
@{
	ViewData["Title"] = "Track Claim #" + Model.ClaimId;
	var claim = ViewBag.Claim as CMCS.Web.Models.Claim;
	var monthName = claim != null ? new DateTime(claim.Year, claim.Month, 1).ToString("MMMM") : "";
}

<div class="row">
	<div class="col-lg-10 mx-auto">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<div>
				<h1 class="mb-1">ğŸ“Š Track Claim #@Model.ClaimId</h1>
				<p class="text-muted mb-0">Real-time status tracking for your claim</p>
			</div>
			<a asp-action="MyClaims" class="btn btn-outline-secondary">
				â† Back to My Claims
			</a>
		</div>

		<!-- Current Status Card -->
		<div class="card shadow-sm mb-4">
			<div class="card-header bg-@Model.StatusColor text-white">
				<h5 class="card-title mb-0">
					@ClaimStatusHelper.GetStatusIcon(Model.CurrentStatus) Current Status: @Model.StatusText
				</h5>
			</div>
			<div class="card-body">
				<div class="row g-3 mb-4">
					<div class="col-md-3">
						<small class="text-muted d-block">Claim ID</small>
						<strong class="fs-5">#@claim.Id</strong>
					</div>
					<div class="col-md-3">
						<small class="text-muted d-block">Period</small>
						<strong class="fs-5">@monthName @claim.Year</strong>
					</div>
					<div class="col-md-3">
						<small class="text-muted d-block">Total Amount</small>
						<strong class="fs-5 text-success">R @claim.Amount.ToString("N2")</strong>
					</div>
					<div class="col-md-3">
						<small class="text-muted d-block">Total Hours</small>
						<strong class="fs-5">@claim.TotalHours.ToString("N2") hrs</strong>
					</div>
				</div>

				<!-- Progress Bar -->
				@if (Model.CurrentStatus != CMCS.Web.Models.ClaimStatus.Rejected)
				{
					<div class="mb-3">
						<div class="d-flex justify-content-between align-items-center mb-2">
							<strong>Progress</strong>
							<span class="text-muted">@Model.ProgressPercentage%</span>
						</div>
						<div class="progress" style="height: 25px;">
							<div class="progress-bar bg-@Model.StatusColor progress-bar-striped progress-bar-animated" 
								 role="progressbar" 
								 style="width: @Model.ProgressPercentage%;" 
								 aria-valuenow="@Model.ProgressPercentage" 
								 aria-valuemin="0" 
								 aria-valuemax="100">
								@Model.ProgressPercentage%
							</div>
						</div>
					</div>
				}
			</div>
		</div>

		<!-- Status Timeline -->
		<div class="card shadow-sm mb-4">
			<div class="card-header bg-light">
				<h5 class="card-title mb-0">ğŸ• Status Timeline</h5>
			</div>
			<div class="card-body">
				<div class="timeline">
					@foreach (var step in Model.StatusSteps)
					{
						var stepClass = step.IsCompleted ? "completed" : step.IsCurrent ? "current" : "pending";
						var iconColor = step.IsCompleted ? "text-success" : step.IsCurrent ? "text-primary" : "text-muted";
						var borderColor = step.IsCompleted ? "border-success" : step.IsCurrent ? "border-primary" : "border-secondary";

						<div class="timeline-item @stepClass mb-4">
							<div class="d-flex align-items-start">
								<div class="timeline-icon me-3">
									<div class="border @borderColor rounded-circle d-flex align-items-center justify-content-center bg-white" 
										 style="width: 60px; height: 60px;">
										<span class="fs-3">@step.Icon</span>
									</div>
								</div>
								<div class="timeline-content flex-grow-1">
									<div class="card border-@(step.IsCompleted ? "success" : step.IsCurrent ? "primary" : "secondary")">
										<div class="card-body">
											<div class="d-flex justify-content-between align-items-center">
												<div>
													<h6 class="mb-1 @iconColor">
														<strong>@step.StepName</strong>
														@if (step.IsCompleted && !step.IsCurrent)
														{
															<span class="badge bg-success ms-2">âœ“ Completed</span>
														}
														@if (step.IsCurrent)
														{
															<span class="badge bg-primary ms-2">â— Current</span>
														}
													</h6>
													<p class="text-muted mb-0 small">@step.Description</p>
												</div>
												@if (step.IsCompleted)
												{
													<div class="text-success fs-3">âœ“</div>
												}
											</div>
										</div>
									</div>
								</div>
							</div>
							@if (step != Model.StatusSteps.Last())
							{
								<div class="timeline-connector ms-4"></div>
							}
						</div>
					}
				</div>
			</div>
		</div>

		<!-- Status Information -->
		<div class="card shadow-sm mb-4">
			<div class="card-header bg-info text-white">
				<h5 class="card-title mb-0">â„¹ï¸ What Happens Next?</h5>
			</div>
			<div class="card-body">
				@if (Model.CurrentStatus == CMCS.Web.Models.ClaimStatus.Submitted)
				{
					<div class="alert alert-primary">
						<strong>ğŸ” Awaiting Verification</strong>
						<p class="mb-0 mt-2">Your claim is currently being reviewed by the Programme Coordinator. They will verify the details and supporting documents.</p>
					</div>
				}
				else if (Model.CurrentStatus == CMCS.Web.Models.ClaimStatus.Verified)
				{
					<div class="alert alert-info">
						<strong>âœ… Awaiting Approval</strong>
						<p class="mb-0 mt-2">Your claim has been verified and is now pending approval from the Academic Manager for final authorization.</p>
					</div>
				}
				else if (Model.CurrentStatus == CMCS.Web.Models.ClaimStatus.Approved)
				{
					<div class="alert alert-success">
						<strong>ğŸ’° Approved - Awaiting Payment</strong>
						<p class="mb-0 mt-2">Congratulations! Your claim has been approved and will be forwarded to Finance for payment processing.</p>
					</div>
				}
				else if (Model.CurrentStatus == CMCS.Web.Models.ClaimStatus.Rejected)
				{
					<div class="alert alert-danger">
						<strong>âŒ Claim Rejected</strong>
						<p class="mb-0 mt-2">Unfortunately, your claim has been rejected. Please contact the coordinator or manager for more information and resubmit if necessary.</p>
					</div>
				}
				else if (Model.CurrentStatus == CMCS.Web.Models.ClaimStatus.Settled)
				{
					<div class="alert alert-dark">
						<strong>ğŸ‰ Payment Settled</strong>
						<p class="mb-0 mt-2">Your claim has been fully processed and payment has been completed. Thank you!</p>
					</div>
				}
				else
				{
					<div class="alert alert-secondary">
						<strong>ğŸ“ Draft Status</strong>
						<p class="mb-0 mt-2">Your claim is still in draft status. Please complete and submit it for processing.</p>
					</div>
				}
			</div>
		</div>

		<!-- Quick Actions -->
		<div class="card shadow-sm">
			<div class="card-body">
				<h6 class="card-title mb-3">ğŸ”§ Quick Actions</h6>
				<div class="d-grid gap-2 d-md-flex">
					<a asp-action="UploadDocuments" asp-route-id="@claim.Id" class="btn btn-primary">
						ğŸ“ Upload Documents
					</a>
					<a asp-action="MyClaims" class="btn btn-outline-secondary">
						ğŸ“‹ View All Claims
					</a>
					<button type="button" class="btn btn-outline-info" onclick="location.reload()">
						ğŸ”„ Refresh Status
					</button>
				</div>
			</div>
		</div>
	</div>
</div>

<style>
	.timeline-connector {
		width: 3px;
		height: 40px;
		background: linear-gradient(to bottom, #dee2e6 0%, #dee2e6 100%);
		margin-left: 28px;
	}

	.timeline-item.completed .timeline-connector {
		background: linear-gradient(to bottom, #28a745 0%, #28a745 100%);
	}

	.timeline-item.current .timeline-connector {
		background: linear-gradient(to bottom, #0d6efd 0%, #dee2e6 100%);
	}
</style>

